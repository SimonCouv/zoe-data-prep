---
title: "TwinsUK COVID-19 Radar Participation Report"
date: "`r format(Sys.time(), '%d %B %Y - %H:%M:%S')`"
author: "Simon Couvreur"
output: 
  pdf_document
editor_options: 
  chunk_output_type: console
params:
    wdir: ""
    rdir: ""
    timestamp: ""
---


```{r setup, include=F}

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(patchwork)
library(lubridate)
library(dplyr)
library(ggplot2)
library(data.table)


```

```{r}

a <- fread(sprintf("%s/cleaned_twins_assessments_export_%s.csv", params$wdir, params$timestamp))

```

# Data

Timestamp: `r params$timestamp`


Individuals in TUK with >= 1 assessment: `r n_distinct(a$patient_id)`


# Participation per day

```{r, out.width="100%", fig.width=10 ,fig.height=12}


participation <- a %>% 
  mutate(date_updated_at = as_date(updated_at)) %>% 
  arrange(patient_id, date_updated_at) %>% 
  group_by(patient_id) %>% 
  mutate(n_prev_sub = 0:(n()-1)) %>% 
  ungroup() %>% 
  count(date_updated_at, n_prev_sub)
p_global <- participation %>% 
  group_by(date_updated_at) %>% 
  summarise(n=sum(n)) %>% 
  ggplot(aes(date_updated_at, n))+
  geom_bar(stat = "identity") +
  scale_x_date(date_breaks = "1 day")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  xlab("date of submission")+
  ylab("number of reports from twins")

p_rank <- ggplot(participation, aes(x=date_updated_at, y=n,fill=n_prev_sub))+
  geom_bar(stat = "identity") +
  scale_x_date(date_breaks = "1 day")+
  theme_bw()+
  scale_fill_gradient(low = "blue", high = "red", name="number of previous submissions by individual")+
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")+
  xlab("date of submission")+
  ylab("number of reports from twins")

p_novel <- ggplot(participation, aes(x=date_updated_at, y=n,fill=n_prev_sub==0))+
  geom_bar(stat = "identity") +
  scale_x_date(date_breaks = "1 day")+
  theme_bw()+
  scale_fill_discrete(name="first submission by individual")+
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")+
  xlab("date of submission")+
  ylab("number of reports from twins")


p_global/(p_rank+p_novel)


```

# Participation matrix

Allows to view the new participants (TwinsUK only) on any given day as
a separate sub-cohort and analyse their reporting

```{r, out.width="100%", fig.width=10 ,fig.height=12}


a %>% 
  mutate(date_updated_at = as_date(updated_at)) %>% 
  group_by(patient_id) %>% 
  mutate(date_first_log = min(date_updated_at)) %>% 
  ungroup() %>% 
  dplyr::filter(date_updated_at < today()) %>% 
  count(date_updated_at, date_first_log) %>% 
  ggplot(aes(x=date_updated_at, y=date_first_log, fill=n))+
  geom_tile()+
  geom_text(aes(label=n), size=3)+
  theme_bw()+
  ylab("date of first report")+
  xlab("report day")+
  scale_fill_gradient(low = "blue", high = "red", name="number of reports")+
  theme(legend.position = "top")

```

# Retention matrix

Similar to participation matrix but, for each sub-cohort defined by date of first
submission, expresses the number of reports submitted as percent of sub-cohort size.

```{r, out.width="100%", fig.width=10 ,fig.height=12}

a %>% 
  mutate(date_updated_at = as_date(updated_at)) %>% 
  group_by(patient_id) %>% 
  mutate(date_first_log = min(date_updated_at)) %>% 
  ungroup() %>% 
  count(date_updated_at, date_first_log) %>% 
  dplyr::filter(date_updated_at < today()) %>% 
  group_by(date_first_log) %>% 
  mutate(n_total = max(n),
         retention =n/n_total*100,
         retention_str = paste0(round(retention), "%")) %>% 
  ggplot(aes(x=date_updated_at, y=date_first_log, fill=retention))+
  geom_tile()+
  geom_text(aes(label=round(retention)), size=3)+
  theme_bw()+
  ylab("date of first report")+
  xlab("report day")+
  scale_fill_gradient(low = "blue", high = "red", name="percent reporting\n(relative to day of first report)")+
  theme(legend.position = "top")
  

```

# Reports per individual

```{r}

a %>% count(patient_id) %>% 
  count(n) %>% 
  ggplot(aes(n, nn))+
  geom_bar(stat="identity")+
  xlab("number of reports submitted")+
  ylab("number of individuals")+
  theme_bw()

```

